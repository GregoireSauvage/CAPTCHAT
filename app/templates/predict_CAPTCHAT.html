<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Suivi du mouvement de la souris</title>
    <style>
        /* Styles pour le tableau */
        table {
            width: 60%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        th {
            background-color: #f2f2f2;
            text-align: left;
        }
        #stopButton {
            margin: 0px 0;
        }
    </style>
</head>
<body>
    <!-- Bouton pour arrêter l'enregistrement et envoyer les données -->
    <button id="stopButton">Vérifier</button>

    <!-- Conteneur pour le tableau des résultats -->
    <div id="results-container"></div>

    <script>

        // Fonction pour générer un identifiant de session unique
        function generateSessionId() {
            return '_' + Math.random().toString(36).substr(2, 9);
        }
        // Générer et stocker l'identifiant de session
        const sessionId = generateSessionId();


        // Tableaux pour stocker les mouvements de souris et les clics
        let mouseMovements = [];
        let clickCoordinates = [];
        const MAX_TIME = 5000; // 5 secondes en millisecondes

        // Variable pour limiter la fréquence de collecte (throttling)
        let firstRecordedTime = 0;
        let lastRecordedTime = 0;

        // Gestionnaire pour le mouvement de la souris
        function mouseMoveHandler(event) {
            if (firstRecordedTime === 0) {
                firstRecordedTime = Date.now();
            }
            let now = Date.now() - firstRecordedTime;
            if (now - lastRecordedTime > 50) { // Enregistrer toutes les 50 ms
                lastRecordedTime = now;
                mouseMovements.push({
                    x: event.clientX,
                    y: event.clientY,
                    time: now
                });

                // Supprimer les mouvements de souris plus anciens que 5 secondes
                mouseMovements = mouseMovements.filter(movement => now - movement.time <= MAX_TIME);
            }
        }

        // Gestionnaire pour les clics de souris
        function clickHandler(event) {
            let now = Date.now();
            clickCoordinates.push({
                x: event.clientX,
                y: event.clientY,
                time: now
            });

            // Supprimer les clics plus anciens que 5 secondes
            clickCoordinates = clickCoordinates.filter(click => now - click.time <= MAX_TIME);
        }

        // Attacher les écouteurs d'événements
        document.addEventListener('mousemove', mouseMoveHandler);
        document.addEventListener('click', clickHandler);

        // Fonction pour envoyer les données au serveur Flask
        function sendData() {
            // Préparation des données à envoyer
            let data = {
                session_id: sessionId, // Inclure l'identifiant de session pour différencier les essais
                mouseMovements: mouseMovements,
                clickCoordinates: clickCoordinates
            };
        
            // Envoi des données au serveur via une requête POST
            fetch('/predict', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Créer le tableau si ce n'est pas déjà fait
                    let table = document.getElementById('results-table');
                    if (!table) {
                        table = document.createElement('table');
                        table.id = 'results-table';

                        // Créer l'en-tête du tableau
                        const header = table.createTHead();
                        const headerRow = header.insertRow(0);
                        const cellModel = headerRow.insertCell(0);
                        const cellPrediction = headerRow.insertCell(1);
                        const cellLink = headerRow.insertCell(2);
                        cellModel.innerHTML = "<b>Modèle</b>";
                        cellPrediction.innerHTML = "<b>Prédiction</b>";
                        cellLink.innerHTML = "<b>Lien</b>";

                        // Ajouter le tableau au conteneur
                        document.getElementById('results-container').appendChild(table);
                    }

                    // Ajouter les prédictions au tableau
                    const tbody = table.getElementsByTagName('tbody')[0] || table.createTBody();

                    data.predictions.forEach(predictionData => {
                        const row = tbody.insertRow();
                        const cellModel = row.insertCell(0);
                        const cellPrediction = row.insertCell(1);
                        const cellLink = row.insertCell(2);
                    
                        cellModel.innerText = predictionData.model;
                        cellPrediction.innerText = predictionData.prediction;
                    
                        // Créer le lien vers la page explicative du modèle
                        const link = document.createElement('a');
                        link.href = predictionData.link;
                        link.innerText = 'En savoir plus';
                        cellLink.appendChild(link);
                    });
                } else {
                    alert('Erreur lors de l\'analyse des données : ' + data.message);
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
            });
        }

        // Écouteur pour le bouton "Vérifier"
        document.getElementById('stopButton').addEventListener('click', function() {
            // Supprimer les écouteurs d'événements pour arrêter l'enregistrement
            document.removeEventListener('mousemove', mouseMoveHandler);
            document.removeEventListener('click', clickHandler);

            // Envoyer les données au serveur
            sendData();
        });
    </script>
</body>
</html>
